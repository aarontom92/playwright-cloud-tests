name: Scheduled Playwright Tests

on:
  schedule:
    # Voer iedere dag om 07:00 UTC uit (pas cron aan naar wens)
    - cron: "*/3 * * * *"
  workflow_dispatch:
    # Hiermee kun je de workflow ook handmatig starten vanuit GitHub

# Cancel overlapping runs of this workflow
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  test:
    # Pin naar Ubuntu 22.04 zodat Playwright's --with-deps script de juiste pakketten vindt.
    runs-on: ubuntu-22.04
    # Gebruik Playwright Docker image met vooraf geïnstalleerde browsers + deps
    container:
      image: mcr.microsoft.com/playwright:v1.29.2-focal
    env:
      # Sla browser downloads over; image bevat browsers al
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
      # Secret credentials voor tests (stel deze in bij Repo Settings → Secrets and variables → Actions)
      PW_USER_AARON: ${{ secrets.PW_USER_AARON }}
      PW_PASS_AARON: ${{ secrets.PW_PASS_AARON }}
      PW_USER_REINIER: ${{ secrets.PW_USER_REINIER }}
      PW_PASS_REINIER: ${{ secrets.PW_PASS_REINIER }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check quiet hours (Europe/Amsterdam)
        id: quiet
        shell: bash
        run: |
          set -euo pipefail
          export TZ=Europe/Amsterdam
          HM=$(date +%H%M)
          echo "Local time Europe/Amsterdam: $(date) (HM=$HM)"
          if [ "$HM" -lt 630 ]; then
            echo "Within quiet hours (00:00-06:30). Skipping heavy steps."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Restore node_modules cache
        id: node-modules-cache
        uses: actions/cache@v4
        if: steps.quiet.outputs.skip != 'true'
        with:
          path: node_modules
          key: ${{ runner.os }}-node-20-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-20-modules-

      - name: Install dependencies
        if: steps.quiet.outputs.skip != 'true' && steps.node-modules-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Run Playwright tests
        if: steps.quiet.outputs.skip != 'true'
        run: npx playwright test
